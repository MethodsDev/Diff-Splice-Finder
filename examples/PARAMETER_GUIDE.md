# Differential Splicing Analysis - Parameter Guide

## Required Inputs

### 1. Intron Count Matrix
- Tab-delimited file with intron IDs as rows and samples as columns
- Format: `chr:start-end^splice_pair^flag`
- Example: `chr20:3864789-3865682^GT--AG^OK`
- Generated by `build_intron_count_matrix.py`

### 2. Sample Metadata File
- Tab-delimited file with sample information
- Required columns:
  - `sample_id`: Must match column names in count matrix
  - `group`: Sample group for comparison (e.g., "TDP43", "control")
- Optional columns:
  - `batch`: Batch identifier for batch correction

## Pipeline Parameters

### Analysis Mode

The pipeline runs a **single intron-level analysis** using shared offsets:
- Each intron is tested **once** (not separately for donor and acceptor)
- Uses `max(donor_cluster_total, acceptor_cluster_total)` as the offset
- Prevents singleton cluster artifacts
- Provides comprehensive information from both splice sites

### Filtering Parameters

#### Intron-level filters (default values)
- `--min_intron_count 10`: Minimum total reads across all samples
- `--min_intron_samples 2`: Minimum samples with non-zero counts
- `--keep_noncanonical`: Keep non-canonical splice sites (NOT recommended)

**Rationale**: Removes low-confidence introns likely to be noise or artifacts

#### Cluster-level filters (default values)
- `--min_cluster_count 20`: Minimum total reads per sample in a cluster
- `--min_cluster_samples 3`: Minimum samples meeting the count threshold

**Important**: Both donor AND acceptor clusters must meet thresholds for an intron to pass filtering.

**Rationale**: Ensures sufficient power for compositional analysis and prevents testing introns with inadequate support at either splice site

### edgeR Statistical Parameters

- `--group_col group`: Column name for sample groups
- `--batch_col`: Optional column for batch correction
- `--contrast "GroupA-GroupB"`: Specific contrast to test
  - If not specified, performs all pairwise comparisons between groups
  - Format: "TreatmentGroup-ControlGroup"
- `--control_groups "control1,control2"`: Specify control groups for comparison
  - If specified, all non-control groups are compared against the control group(s)
  - Multiple controls can be provided as comma-separated values
  - Example: `--control_groups control` compares all groups to control
  - Example: `--control_groups control,wildtype` pools control and wildtype as reference
  - Cannot be used together with `--contrast`
  - **Use case**: When you have specific control/reference groups and want to compare all treatments against them rather than performing all pairwise comparisons
- `--fdr_threshold 0.05`: FDR cutoff for significance
- `--min_logFC 0.0`: Minimum absolute log2 fold-change

**Note**: logFC represents change in **intron usage proportion**, not expression

### PSI Filtering Parameters (Optional)

- `--min_delta_psi`: Minimum absolute delta PSI to include in final results
  - Example: `--min_delta_psi 0.1` requires ≥10% change in PSI
  - FDR is recalculated on the filtered set (reduces multiple testing burden)
  - Creates both unfiltered and filtered output files for comparison
  - **Use case**: Focus on biologically meaningful splicing changes with substantial effect sizes

### Pipeline Control

- `--force_rerun`: Force complete rerun from scratch
  - By default, the pipeline resumes where it left off if interrupted
  - Checks for existing output files and skips completed steps
  - Use this flag to regenerate all results

**Resume Behavior**: If the pipeline crashes or is interrupted, simply rerun the same command. It will automatically skip any steps that completed successfully and resume from where it stopped. This is especially useful for long-running analyses or when testing parameters.

## Output Files

### Primary Results

**Intron-level results:**
- `edgeR_results.intron_results.tsv`: All tested introns with edgeR statistics
- `edgeR_results.intron_results_with_psi.tsv`: **Results with PSI values (unfiltered)**
  - Always created, contains all introns regardless of delta PSI
  - Useful for exploring results and debugging
- `edgeR_results.intron_results_with_psi.psi_filtered.tsv`: Filtered by delta PSI
  - Only created if `--min_delta_psi` specified
  - Contains only introns meeting delta PSI threshold
  - FDR recalculated on this filtered set
- `edgeR_results.significant_introns.tsv`: Introns passing FDR threshold

**PSI values:**
- `psi.psi_values.tsv`: Per-sample PSI, group means, and delta PSI

**Shared offsets:**
- `shared_offsets.raw_cluster_totals.tsv`: Raw cluster totals (max of donor/acceptor)
- `shared_offsets.log_offsets.tsv`: Log-transformed for edgeR

**Diagnostics:**
- `edgeR_results.diagnostics.pdf`: BCV, dispersion, MA, volcano plots

**Key columns in results:**
- `intron_id`: Coordinates and splice sites
- `donor_cluster`: Donor cluster ID (chr:donor_pos:strand)
- `acceptor_cluster`: Acceptor cluster ID (chr:acceptor_pos:strand)
- `gene_name`: Gene annotation (if GTF provided)
- `logFC`: Log2 fold-change in proportional usage
- `FDR`: Adjusted p-value
- `*_mean_PSI`: Mean PSI in each group
- `delta_PSI`: Difference in mean PSI

1. **Filtered matrices**
   - `{cluster_type}_filtered.tsv`: Introns passing filters with cluster assignments

2. **edgeR input files**
   - `{cluster_type}_edgeR_input.counts.tsv`: Count matrix
   - `{cluster_type}_edgeR_input.offsets.tsv`: Log cluster-total offsets
   - `{cluster_type}_edgeR_input.annotations.tsv`: Intron metadata

3. **Intron-level results**
   - `{cluster_type}_edgeR_results.intron_results.tsv`: All tested introns
   - `{cluster_type}_edgeR_results.significant_introns.tsv`: FDR-significant introns
   - `{cluster_type}_edgeR_results.RData`: R objects for further analysis

4. **Cluster-level results**
   - `{cluster_type}_aggregated.cluster_results.tsv`: Cluster-level statistics
   - `{cluster_type}_aggregated.significant_cluster_introns.tsv`: Introns in significant clusters

5. **Diagnostics**
   - `{cluster_type}_edgeR_results.diagnostics.pdf`: BCV, dispersion, MA, volcano plots

## Interpretation Guide

### Integrated Results Columns
- `intron_id`: Intron coordinates and splice sites
- `tested_in`: Which clustering strategies tested this intron
- `significant_in`: Which analyses found this intron significant
- `best_analysis`: donor or acceptor (whichever has lower FDR)
- `best_FDR`: Minimum FDR across both analyses
- `best_logFC`: LogFC from the best analysis
- `direction_consistent`: Do donor and acceptor agree on direction? (for introns significant in both)
- `donor_*`: All columns from donor analysis
- `acceptor_*`: All columns from acceptor analysis

### Intron-level Results Columns (per cluster type)
- `intron_id`: Intron coordinates and splice sites
- `logFC`: Log2 fold-change in **intron usage proportion**
  - Positive: increased usage in first group
  - Negative: decreased usage in first group
- `PValue`: P-value from QL F-test
- `FDR`: Benjamini-Hochberg adjusted p-value
- `cluster`: Cluster assignment
- `significant`: Boolean flag (FDR < threshold & |logFC| >= threshold)

### Cluster-level Results Columns
- `cluster`: Cluster identifier (chr:position:strand)
- `n_introns`: Number of introns in cluster
- `n_significant_introns`: Number with FDR-significant usage changes
- `cluster_pvalue`: Combined p-value across introns
- `cluster_FDR`: Cluster-level FDR
- `dominant_direction`: Overall splicing pattern in the cluster
  - **increased**: More significant introns show increased usage (n_increased > n_decreased)
  - **decreased**: More significant introns show decreased usage (n_decreased > n_increased)
  - **mixed**: Equal number of increased and decreased introns (biologically interesting - indicates complex splicing changes where some alternatives are favored and others disfavored)
  - **none**: No significant introns in cluster
- `n_increased`: Number of significant introns with positive logFC
- `n_decreased`: Number of significant introns with negative logFC
- `max_abs_logFC`: Largest absolute logFC among significant introns
- `mean_logFC`: Mean logFC of significant introns

## Parameter Tuning Recommendations

### For Short-Read RNA-seq (Illumina)
Use default parameters or slightly stricter:
```bash
--min_intron_count 10 \
--min_intron_samples 3 \
--min_cluster_count 30 \
--min_cluster_samples 3
```

### For Long-Read RNA-seq (PacBio/ONT)
Use more lenient filtering due to sparsity:
```bash
--min_intron_count 5 \
--min_intron_samples 2 \
--min_cluster_count 10 \
--min_cluster_samples 2
```

### For High-Depth Studies
Can use stricter thresholds:
```bash
--min_intron_count 20 \
--min_cluster_count 50
```

### For Low-Replicate Studies (n=2-3)
Must be more lenient:
```bash
--min_intron_samples 2 \
--min_cluster_samples 2
```

## Common Issues and Solutions

### Issue: Very few significant results
**Possible causes:**
- Insufficient biological replicates (need ≥3 per group)
- Over-stringent filtering (try reducing thresholds)
- Low sequencing depth
- No real biological differences

**Solutions:**
- Check diagnostic plots (BCV, dispersion)
- Review cluster size distribution in logs
- Try less stringent `min_logFC`

### Issue: Too many significant results
**Possible causes:**
- Batch effects not accounted for
- Under-filtering (too much noise)
- Strong biological effect (good!)

**Solutions:**
- Add `--batch_col` if applicable
- Increase filtering thresholds
- Increase `min_logFC` threshold

### Issue: Different results between donor and acceptor
**This is expected!** Different clustering captures different splicing patterns:
- Donor clusters: alternative 3' splice sites, intron retention
- Acceptor clusters: alternative 5' splice sites

Use both analyses together for comprehensive splicing detection.

## Example Workflows

### Basic Analysis
```bash
python3 run_diff_splice_analysis.py \
    --matrix intron_counts.matrix \
    --samples sample_metadata.tsv \
    --output_dir results
```

### With Batch Correction
```bash
python3 run_diff_splice_analysis.py \
    --matrix intron_counts.matrix \
    --samples sample_metadata.tsv \
    --output_dir results \
    --batch_col batch
```

### Control-Based Comparisons
When you have control samples and want to compare all treatment groups against them:
```bash
python3 run_diff_splice_analysis.py \
    --matrix intron_counts.matrix \
    --samples sample_metadata.tsv \
    --output_dir results \
    --control_groups control
```

This will compare each non-control group (e.g., TDP43, FUS, TARDBP) against the control group.

For multiple control types (e.g., control and wildtype):
```bash
python3 run_diff_splice_analysis.py \
    --matrix intron_counts.matrix \
    --samples sample_metadata.tsv \
    --output_dir results \
    --control_groups control,wildtype
```

This pools control and wildtype samples as a reference and compares all other groups against them.

**Benefits:**
- Reduces multiple testing burden by focusing on biologically relevant comparisons
- More intuitive results when your experiment has clear control/treatment structure
- Increases statistical power by reducing the number of tests

### Conservative Analysis (fewer false positives)
```bash
python3 run_diff_splice_analysis.py \
    --matrix intron_counts.matrix \
    --samples sample_metadata.tsv \
    --output_dir results \
    --min_intron_count 20 \
    --min_cluster_count 50 \
    --min_logFC 1.0 \
    --fdr_threshold 0.01
```

### Liberal Analysis (more discovery)
```bash
python3 run_diff_splice_analysis.py \
    --matrix intron_counts.matrix \
    --samples sample_metadata.tsv \
    --output_dir results \
    --min_intron_count 5 \
    --min_cluster_count 10 \
    --fdr_threshold 0.10
```
